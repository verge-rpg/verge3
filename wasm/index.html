7<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VERGE!</title>
    <style>
        html, body {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        body {
            font-family: sans-serif;
            background-color: #0a0804;
            color: #a8a0a0;
            text-align: center;
        }

        .vergeContainer {
            width: 100%;
            height: 100%;
            position: relative;
            display: grid;
            grid-template-columns: 225px auto 225px;
            grid-template-rows: 75px auto 50px 25px;
            grid-template-areas:
                "header header header"
                "leftside playarea controls"
                "leftside loadingbar controls"
                "footer footer footer"
            ;
        }

        #canvasContainer {
            grid-area: playarea;
            align-self: stretch;
            justify-self: stretch;
            display: flex;
            align-items: center;
            justify-items: center;
        }

        canvas {
            image-rendering: pixelated;
            z-index: 999;
            margin: auto;
        }

        #loadingProgress {
            width: 624px;
            margin: auto;
            border: 4px solid gray;
            padding: 4px;
            height: 1em;
            position: relative;
            transition: opacity 2s;
            grid-area: loadingbar;
            align-self: center;
            justify-self: center;
        }

        #loadingProgress div {
            background-color: green;
            margin: 4px;
            position: absolute;
            left: 0;
            right: 100%;
            top: 0;
            bottom: 0;
        }

        #controls {
            text-align: left;
            z-index: -1;
            grid-area: controls;
            padding: 0.5em;
        }

        #no-audio-worklet {
            display: none;
        }

        header {
            font-size: 32px;
            grid-area: header;
            align-self: center;
            justify-self: center;
        }

        footer {
            font-size: 9px;
            grid-area: footer;
            align-self: center;
            justify-self: center;
        }

    </style>
</head>
<body>
    <div class="vergeContainer">
        <header>VERGE</header>
        <div id="canvasContainer">
            <canvas id="canvas" width="320" height="200"></canvas>
        </div>
        <div id='loadingProgress'><div></div></div>
        <div id='controls'>
            <h2>Controls</h2>
            <dl>
                <dt>Arrow keys</dt><dd>Move</dd>
                <dt>Enter</dt><dd>Interact, select menu options</dd>
                <dt>Tab</dt><dd>Cancel out of menus</dd>
                <dt>Space</dt><dd>Main menu (items, equipment, etc)</dd>
                <dt>ESC</dt><dd>System menu (save, load, etc)</dd>
            </dl>
            <h2>Gamepad Controls</h2>
            <dl>
                <dt>A</dt><dd>Interact</dd>
                <dt>B</dt><dd>Cancel</dd>
                <dt>Y</dt><dd>Main menu</dd>
                <dt>Start</dt><dd>System Menu</dd>
            </dl>
            <div id='no-audio-worklet'>
                Your browser does not support AudioWorklet.  We cannot play any music.  Sorry!<br />
                The latest versions of Chrome and Firefox should work!
            </div>
        </div>
        <footer id="build-date"></footer>
    </div>

    <script>
        (function() {
            const screen_size = [320, 200];
            const canvas = document.getElementById('canvas');
            const canvasContainer = canvas.parentNode;
            canvas.setAttribute('width', screen_size[0]);
            canvas.setAttribute('height', screen_size[1]);

            const resizeCallback = (e) => {
                canvas.style.display = "none";

                const parentRect = canvasContainer.getClientRects()[0];
                const scaleX = (parentRect.width / screen_size[0]) | 0;
                const scaleY = (parentRect.height / screen_size[1]) | 0;
                const scale = Math.max(Math.min(scaleX, scaleY), 1);

                canvas.style.width = (screen_size[0] * scale) + "px";
                canvas.style.height = (screen_size[1] * scale) + "px";
                canvas.style.display = "";
            };

            window.addEventListener('resize', resizeCallback);
            resizeCallback();

            if (!('audioWorklet' in AudioContext.prototype)) {
                document.getElementById('no-audio-worklet').style.display = 'block';
            }
        })();

        (function() {
            const ctx = document.getElementById('canvas').getContext('2d');
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, 320, 200);

            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText('Loading! :D', 160, 100);
        })();
        </script>

        <!--
            DIRECTIONS:

            Have a 320x200 canvas with the id canvas.

            Define a function window.verge.setLoadingProgress.  It takes a number which describes
            the loading progress.  The application will always call setLoadingProgress with a value of
            100 when loading is complete.

            Set window.Module to {arguments: ["gameroot_dir/"]}
            The game root dir is a relative path to a manifest.txt.  This file describes all the stuff
            needed to run the game.

            Once you have done all of this, include verge3.out.js with a script tag.
        -->
        <script>
            const TIMELESS_FOLDER = 'timeless'
            const TIMELESS_PATHS = [
                "animation.vc",
                "background/bobblue.gif",
                "background/bobcyan.gif",
                "background/bobgreen.gif",
                "background/bobred.gif",
                "background/evilgd1.pcx",
                "background/evilgd2.pcx",
                "background/evilgrad.gif",
                "background/evilgrad1.gif",
                "background/evilgrad2.gif",
                "background/evilgrad3.gif",
                "background/face_blue.gif",
                "background/face_green.gif",
                "background/face_red.gif",
                "background/grad1.png",
                "background/grad2.png",
                "background/grad3.png",
                "background/grad4.png",
                "background/grad5.png",
                "background/grad6.png",
                "background/grad7.png",
                "background/lightning.gif",
                "background/sphereblue.gif",
                "background/spheregreen.gif",
                "background/spheregrey.gif",
                "background/sphereorange.gif",
                "background/spherepurple.gif",
                "background/tiledbg0.gif",
                "background/tiledbg1.gif",
                "background/tiledbg2.gif",
                "background/tiledbg3.gif",
                "background/tiledbg4.gif",
                "background/tiledbg5.gif",
                "background/tiledbg6.gif",
                "background/tiledbg7.gif",
                "background/tiledbg8.gif",
                "background/tiledbg9.gif",
                "background/_grad1.png",
                "background/_grad2.png",
                "background/_grad3.png",
                "background/_grad4.png",
                "background/_grad5.png",
                "background/_grad6.png",
                "background/_grad7.png",
                "background/_grad8.png",
                "backgrounds.txt",
                "bg.png",
                "bgr.vc",
                "bgr0.vc",
                "bgr1.vc",
                "bgr2.vc",
                "bgr3.vc",
                "bgr4.vc",
                "bgr5.vc",
                "bgr6.vc",
                "bgr6a.vc",
                "bgr6b.vc",
                "bgra.vc",
                "bgrb.vc",
                "bgrc.vc",
                "bgrd.vc",
                "lens.vc",
                "le_beneath.vc",
                "le_grey.vc",
                "le_scale.vc",
                "le_tint.vc",
                "lm_bounce.vc",
                "lm_horiz.vc",
                "lm_vert.vc",
                "manifest.txt",
                "menu.gif",
                "music/lib-grey.xm",
                "music/rain.s3m",
                "music/sully-columns.it",
                "music/verge6.it",
                "music/zcs-02-intro.xm",
                "music/zk-jdood.it",
                "prepos.txt",
                "resource.vc",
                "sprites/bigeye.gif",
                "sprites/bigeye_green.gif",
                "sprites/bigheart.gif",
                "sprites/bigsmile.gif",
                "sprites/candle.gif",
                "sprites/circle.gif",
                "sprites/ele-anti.gif",
                "sprites/ele-arse.gif",
                "sprites/ele-gold.gif",
                "sprites/ele-iron.gif",
                "sprites/ele-merc.gif",
                "sprites/ele-phos.gif",
                "sprites/ele-pota.gif",
                "sprites/ele-silv.gif",
                "sprites/ele-sulf.gif",
                "sprites/evilmask.gif",
                "sprites/fish2.gif",
                "sprites/fishie.gif",
                "sprites/flame.gif",
                "sprites/flower.gif",
                "sprites/flower_green.gif",
                "sprites/flyeye.gif",
                "sprites/flyeye_green.gif",
                "sprites/flyheart.gif",
                "sprites/flymask.gif",
                "sprites/flyskull.gif",
                "sprites/greenmoon.gif",
                "sprites/halo.png",
                "sprites/hearts.gif",
                "sprites/hourglass.gif",
                "sprites/leafie.gif",
                "sprites/leaf_green.gif",
                "sprites/moon.gif",
                "sprites/planet.gif",
                "sprites/raindrop.gif",
                "sprites/skullofawesome.gif",
                "sprites/sluggy.gif",
                "sprites/slug_brown.gif",
                "sprites/smallclock.gif",
                "sprites/smalleye.gif",
                "sprites/smalleye_green.gif",
                "sprites/smallflower.gif",
                "sprites/smallflower_green.gif",
                "sprites/smallsmile.gif",
                "sprites/smallsun.gif",
                "sprites/smallsun_green.gif",
                "sprites/smile_green.gif",
                "sprites/snow.gif",
                "sprites/sun.gif",
                "sprites/tinyeye.gif",
                "sprites/tinyeye_green.gif",
                "sprites.vc",
                "spr_candle.vc",
                "spr_celestial.vc",
                "spr_circular.vc",
                "spr_fish.vc",
                "spr_flower.vc",
                "spr_flyer.vc",
                "spr_leaves.vc",
                "spr_runes.vc",
                "spr_slug.vc",
                "spr_smilies.vc",
                "spr_weather.vc",
                "system.vc",
                "verge.cfg",
            ];

            const TEST_FOLDER = '';
            const TEST_PATHS = [
                "system.vc",
                "test.png",
                "verge.cfg",
            ];

            const WINGBLASTER_FOLDER = 'wingblaster'
            const WINGBLASTER_PATHS = [
                "background.png",
                "bigbadblocky.png",
                "blocky.png",
                "blockymad.png",
                "bosshit.wav",
                "config.exe",
                "Copy of starfield.png",
                "curvelaser.png",
                "defines.vc",
                "demo.dat",
                "demo.vc",
                "enemy.vc",
                "enemy.vc_",
                "explode.wav",
                "font_white.png",
                "framethrottle.vc",
                "hit.wav",
                "jelly1.wav",
                "laser1.png",
                "laser2.png",
                "lasr1.png",
                "lasr2.png",
                "manifest.txt",
                "masher2.png",
                "object.vc",
                "okboss.xm",
                "ovk_atan2.vc",
                "Readme.txt",
                "ripples.jpg",
                "rock.png",
                "ship.png",
                "shipbad.png",
                "shooter.vc",
                "shot.png",
                "shot.wav",
                "shuriken.png",
                "starfield.png",
                "sword2.wav",
                "system-.vc",
                "system.vc",
                "system.xvc",
                "thin.png",
                "troupe_-_hourlongxplosn.s3m",
                "troupe_-_hourlongxplosn_slow'd.s3m",
                "v3.log",
                "verge.cfg",
            ];

            const HEART_FOLDER = 'heart';
            const HEART_PATHS = [
                'bottomarrow.pcx',
                'CHANGELOG.txt',
                'code/ai.vc',
                'code/animations.vc',
                'code/code.tws',
                'code/effects.vc',
                'code/effects.vh',
                'code/engine.vc',
                'code/equip.vc',
                'code/graphics.vc',
                'code/heartentity.vc',
                'code/input.vc',
                'code/intromenu.vc',
                'code/mapcapture.vc',
                'code/menu.vc',
                'code/music.vc',
                'code/naming.vc',
                'code/save.vc',
                'code/tt64_textbox.vc',
                'code/utility.vh',
                'forest_1-01.map',
                'forest_1-01.vc',
                'forest_1-02.map',
                'forest_1-02.vc',
                'forest_1-03.map',
                'forest_1-03.vc',
                'forest_1-04.map',
                'forest_1-04.vc',
                'forest_1-05.map',
                'forest_1-05.vc',
                'forest_1-06.map',
                'forest_1-06.vc',
                'forest_1-07.map',
                'forest_1-07.vc',
                'heart-enemymagic.rar',
                'heart-naming.rar',
                'heart-oggsounds.rar',
                'heart.zip',
                'images/fire.gif',
                'images/fire.png',
                'images/fireball.gif',
                'images/flame.gif',
                'images/heal.gif',
                'images/heal2.gif',
                'images/heartfill.gif',
                'images/heartvial.gif',
                'images/manafill.gif',
                'images/manavial.gif',
                'images/nova.gif',
                'images/thin.png',
                'manifest.txt',
                'mapcap.rar',
                'MapedPreferences.xml',
                'music/yfforest.it',
                'music/yftown.it',
                'README.txt',
                'save00.sav',
                'save01.sav',
                'save02.sav',
                'save03.sav',
                'sounds/bubbles.ogg',
                'sounds/fireball.ogg',
                'sounds/gasp3.ogg',
                'sounds/iceshort.ogg',
                'sounds/nova.ogg',
                'sounds/punch.ogg',
                'sounds/steelsword.ogg',
                'sounds/storm.ogg',
                'sounds/wolves.ogg',
                'sprites/bold.chr',
                'sprites/braize.chr',
                'sprites/braizesword.chr',
                'sprites/dorg.chr',
                'sprites/eff.chr',
                'sprites/potions.chr',
                'sprites/shell.chr',
                'sprites/townspeople.chr',
                'system.vc',
                'system.xvc',
                'thin.png',
                'TODO.txt',
                'town.map',
                'town.vc',
                'town.vsp',
                'v3.log',
                'verge.cfg',
            ]

            const SNOWBALL_FOLDER = 'snowball';
            const SNOWBALL_PATHS = [
                "ai.vc",
                "animation.vc",
                "bat.chr",
                "bat.png",
                "boy.chr",
                "boyspritesheet.png",
                "bw.map",
                "bw.vc",
                "bw.vsp",
                "Changes.txt",
                "Copy of enemy.vc",
                "credits.vc",
                "demo.dat",
                "effects.vc",
                "enemy.vc",
                "event.vc",
                "exitdoor.png",
                "finish.png",
                "font1.png",
                "framethrottle.vc",
                "gauge-green.png",
                "gauge-grey.png",
                "girl.chr",
                "girlspritesheet.png",
                "graphics.vc",
                "grasstile.png",
                "grasstile2.png",
                "hillus.map",
                "hillus.vc",
                "hudinterface.vc",
                "land.ogg",
                "land.wav",
                "level1.map",
                "level1.vc",
                "level1.xm",
                "level2.map",
                "level2.vc",
                "level3.map",
                "level3.vc",
                "levelselect.vc",
                "LevelThumbs/1.png",
                "LevelThumbs/10.png",
                "LevelThumbs/2.png",
                "LevelThumbs/3.png",
                "LevelThumbs/4.png",
                "LevelThumbs/5.png",
                "LevelThumbs/6.png",
                "LevelThumbs/7.png",
                "LevelThumbs/8.png",
                "LevelThumbs/9.png",
                "lynn.chr",
                "mainmenu.vc",
                "manifest.txt",
                "MapedPreferences.xml",
                "mountains.png",
                "obstile.png",
                "pixelfont2.png",
                "platform.vc",
                "platform1.vc",
                "Platformer.tws",
                "poof.png",
                "poof.vc",
                "pop.wav",
                "practice.map.vsp",
                "practiceny.map",
                "practiceny.map.vsp",
                "practiceny.vc",
                "protag.chr",
                "punch.ogg",
                "punch.wav",
                "README.TXT",
                "redmountains.png",
                "resourceLoad.vc",
                "resources.dat",
                "santa.chr",
                "santa.png",
                "save.dat",
                "savegame.vc",
                "sbintro.it",
                "sblevel.it",
                "sbwin.it",
                "SCRATCH.wav",
                "shing.ogg",
                "smw_kick.wav",
                "snow.png",
                "snowball-logo.png",
                "snowball-tiny.png",
                "snowball.png",
                "snowball.vh",
                "snowball.vsp",
                "snowtile.png",
                "SPLASH.ogg",
                "SPLASH.wav",
                "swing.ogg",
                "swing.wav",
                "swing2.ogg",
                "swing2.wav",
                "system.vc",
                "system.vcd",
                "system.xvc",
                "temperaturemap.png",
                "test.vc",
                "thin.png",
                "unlock.wav",
                "v1_maineffects.vc",
                "v3.log",
                "vcc_verbose.txt",
                "verge.cfg",
                "walkloop.ogg",
                "walkloop.wav",
                "water.ogg",
                "weather.vc",
                "windchimes.ogg",
                "windchimes.wav",
            ];            

            MONSOON_FOLDER = 'monsoon'
            MONSOON_PATHS = [
                "code/ability.lua",
                "code/ai.lua",
                "code/box_style.lua",
                "code/controls.lua",
                "code/dialogue.lua",
                "code/direction.lua",
                "code/entity.lua",
                "code/frame_limiter.lua",
                "code/init.lua",
                "code/minimap.lua",
                "code/mungo/mungo.lua",
                "code/npc.lua",
                "code/player.lua",
                "code/progress.lua",
                "code/projectile.lua",
                "code/resources.lua",
                "code/sprite.lua",
                "code/vx/Color.lua",
                "code/vx/ColorFilter.lua",
                "code/vx/Entity.lua",
                "code/vx/File.lua",
                "code/vx/Font.lua",
                "code/vx/Image.lua",
                "code/vx/init.lua",
                "code/vx/Input.lua",
                "code/vx/Lucent.lua",
                "code/vx/Socket.lua",
                "code/vx/Song.lua",
                "code/vx/Sound.lua",
                "code/vx/String.lua",
                "code/vx/System.lua",
                "code/vx/ToString.lua",
                "code/vx/_vergeCamera.lua",
                "code/vx/_vergeClock.lua",
                "code/vx/_vergeJoystickInput.lua",
                "code/vx/_vergeKeyboardInput.lua",
                "code/vx/_vergeMap.lua",
                "code/vx/_vergeMouseInput.lua",
                "code/vx/_vergeMusic.lua",
                "manifest.txt",
                "resources/data/ability.mungo",
                "resources/data/bullet.mungo",
                "resources/fonts/thin.png",
                "resources/images/textbox_arrow.png",
                "resources/maps/MapedPreferences.xml",
                "resources/maps/molasses.lua",
                "resources/maps/molasses.map",
                "resources/maps/molasses.vsp",
                "resources/maps/molasses_tileset.png",
                "resources/sounds/ceiling_bounce.wav",
                "resources/sounds/door_close.wav",
                "resources/sounds/door_open.wav",
                "resources/sounds/explode.wav",
                "resources/sounds/explode2.wav",
                "resources/sounds/explode5.wav",
                "resources/sounds/hitwall.wav",
                "resources/sounds/hurt_enemy.wav",
                "resources/sounds/jump.wav",
                "resources/sounds/land.wav",
                "resources/sounds/land2.wav",
                "resources/sounds/land3.wav",
                "resources/sounds/notice.wav",
                "resources/sounds/shot.wav",
                "resources/sounds/shot2.wav",
                "resources/sounds/shot4.wav",
                "resources/sounds/stun_enemy.wav",
                "resources/sounds/t-gladiator.it",
                "resources/sounds/teleport.wav",
                "resources/sounds/thump.wav",
                "resources/sounds/thump2.wav",
                "resources/sounds/thump3.wav",
                "resources/sounds/__shot.wav",
                "resources/sprites/bird.png",
                "resources/sprites/bird.sprite",
                "resources/sprites/hermit.png",
                "resources/sprites/hermit.sprite",
                "resources/sprites/molasses_meow.png",
                "resources/sprites/molasses_meow.sprite",
                "resources/sprites/neon_heart.png",
                "resources/sprites/shot.sprite",
                "resources/sprites/shot2.sprite",
                "resources/sprites/shot3.sprite",
                "system.lua",
                "system.vc",
                "v3.log",
                "verge.cfg",
            ];


            function fetchSources(folder, paths, completeCallback) {
                let sourcesToFetch = 0;
                let sources = [];
                for (let i = 0; i < paths.length; i++) {
                    ;((i) => {
                        const path = paths[i];
                        const dirname = getDirectoryName(path);
                        const filename = getBaseName(path);

                        console.log('fetching ' + path);

                        sourcesToFetch++;
                        sources.push(null);

                        fetch((folder !== '' ? folder + '/' : '') + path)
                            .then(response => response.arrayBuffer())
                            .then(result => {
                                console.log('fetched ' + path + ' ' + result);
                                sources[i] = {
                                    path: path,
                                    data: new Uint8Array(result),
                                }
                                sourcesToFetch--;

                                if (sourcesToFetch == 0) {
                                    console.log('done');
                                    completeCallback(sources);
                                }
                            })
                            .catch(err => console.log(err));
                    })(i);
                }
            }

            function getDirectoryName(path) {
                const pieces = path.split('/');
                return pieces.length > 1
                    ? pieces.slice(0, pieces.length - 1).join('/')
                    : '.';
            }

            function getBaseName(path) {
                const pieces = path.split('/');
                return pieces.length > 0 ? pieces[pieces.length - 1] : '';
            }

            window.verge = {};

            const verge = window.verge;
            const canvas = document.getElementById('canvas');

            verge.setBuildDate = function(date) {
                document.getElementById('build-date').innerText = `Last Updated ${date}`;
            };

            verge.setLoadingProgress = function(percent) {
                const div = document.querySelector('#loadingProgress div');
                div.style.right = (100 - percent) + '%';
                if (percent == 100) {
                    setTimeout(() => document.getElementById('loadingProgress').style.opacity = '0', 1000);
                }
            };

            let clickedOnce = false;
            const u = new URLSearchParams(window.location.search);
            const game = u.get('game') || 'timeless';
            const folder = TIMELESS_FOLDER;
            const paths = TIMELESS_PATHS;

            canvas.onclick = event => { clickedOnce = true; }

            window.Module = {
                //arguments: [game + '/']
                print: msg => console.log(msg),
                printErr: msg => console.log(msg),
                arguments: [],
                canvas: canvas,
                preRun: function() {
                    window.Module.addRunDependency('vc_source');
                    fetchSources(folder, paths, sources => {
                        console.log('passing sources to emscripten');
                        let dirLevelsToCreate = [];

                        for (const source of sources) {
                            const pieces = getDirectoryName(source.path).split('/');
                            while (dirLevelsToCreate.length < pieces.length) {
                                dirLevelsToCreate.push({});
                            }

                            for (let level = 0; level < pieces.length; level++) {
                                const subpath = pieces.slice(0, level + 1).join('/');
                                dirLevelsToCreate[level][subpath] = subpath;
                            }
                        }

                        for (const dirsToCreate of dirLevelsToCreate) {
                            for (const path in dirsToCreate) {
                                console.log('adding ' + path);
                                window.Module.FS_createPath('.', path, true, true);
                            }
                        }                        

                        for (const source of sources) {
                            const path = source.path;
                            const dirname = getDirectoryName(path);
                            const filename = getBaseName(path);
                            window.Module.FS_createDataFile(dirname, filename, source.data, true, true);
                        }

                        const ctx = document.getElementById('canvas').getContext('2d');
                        ctx.fillStyle = 'green';
                        ctx.fillRect(0, 0, 320, 200);

                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.fillText('Click to start! :D', 160, 100);

                        let interval = setInterval(() => {
                            if (clickedOnce) {
                                window.Module.removeRunDependency('vc_source');

                                window.clearInterval(interval);
                            }
                        }, 1000);
                    });
                },
            };

            if (u.get("statCheat") > 0) {
                window.Module.arguments.push('statCheat');
            }
        </script>
        <script async type="text/javascript" src="verge3.out.js"></script>
</body>
</html>
